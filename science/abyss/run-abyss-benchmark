#!/bin/sh
# needs to run in conda environment abyss

np=1
nt=1

if [ -z $1 ];
then
    	echo >&2 "fatal error: mising argument 1 - total number of CPU cores allocated to the run"
        exit 1
fi

np=$1
if ! [[ $np =~ ^[0-9]+$ ]];
then
    	echo >&2 "fatal error: incorrect format for argument 1. It should be an integer"
        exit 1
fi



if [ -z $2 ];
then
    	echo "warrning: using the same number of specified as threads. It might not be ideal for a multi-node job."
        nt=$np
fi

nt=$2
if ! [[ $nt =~ ^[0-9]+$ ]];
then
    	echo >&2 "fatal error: incorrect format for argument 1. It should be an integer"
        exit 1
fi


test -n "$INPUT_DATA_ROOT_DIR" || {
    echo >&2 "fatal error: missing environment variable INPUT_DATA_ROOT_DIR - source the top-level environment file"
    exit 1
}
test -n "$OUTPUT_DATA_ROOT_DIR" || {
    echo >&2 "fatal error: missing environment variable OUTPUT_DATA_ROOT_DIR - source the top-level environment file"
    exit 1
}

test -n "$NCORES" -a "$NCORES" -ge 1 -a "$NCORES" -le 100 || {
    echo >&2 "fatal error: missing or implausible value for NCORES"
    exit 1
}

datadir=$INPUT_DATA_ROOT_DIR/abyss
outdir=$OUTPUT_DATA_ROOT_DIR/abyss

export datadir

test -d "$datadir" || {
    echo >&2 "fatal error: missing data directory $datadir - unpack the data tarball"
    exit 1
}

mkdir -p "$outdir" || {
    echo >&2 "fatal error: failed to create output directory $outdir"
    exit 1
}

rm -rf "$outdir"/*

type abyss-pe >/dev/null 2>&1 || {
    echo >&2 "fatal error: abyss-pe not found - did you create and activate the abyss conda environment?"
    exit 1
}

abyss-pe -C $outdir np=$np j=$nt k=84 name=abyss2_k84_trans q=20 lib='pe200a pe200b pe500a pe500b' \
mp='mp5kb mp8kb' long='longa longb longc' \
pe200a='${datadir}/L6_V2.notCombined_1.fastq.clipped ${datadir}/L6_V2.notCombined_2.fastq.clipped' \
pe200b='${datadir}/L7_200_V2.notCombined_1.fastq.clipped ${datadir}/L7_200_V2.notCombined_2.fastq.clipped' \
pe500a='${datadir}/L7_500.notCombined_1.fastq.clipped ${datadir}/L7_500.notCombined_2.fastq.clipped' \
pe500b='${datadir}/L8.notCombined_1.fastq.clipped ${datadir}/L8.notCombined_2.fastq.clipped' \
se='${datadir}/L6_V2.extendedFrags.fastq.clipped ${datadir}/L7_200_V2.extendedFrags.fastq.clipped ${datadir}/L7_500.extendedFrags.fastq.clipped ${datadir}/L8.extendedFrags.fastq.clipped' \
longa='${datadir}/Sample1_LongRead_manual_trim.fastq' \
longb='${datadir}/Sample2_LongRead.fastq' \
longc='${datadir}/Sample3_LongRead.fastq' \
mp5kb='${datadir}/GSM02-3Kb_S1_L001_R1_001.fastq ${datadir}/GSM02-3Kb_S1_L001_R2_001.fastq' \
mp8kb='${datadir}/GSM02-8Kb_S1_L001_R1_001.fastq ${datadir}/GSM02-8Kb_S1_L001_R2_001.fastq' \
>$outdir/abyss2_k84_trans.out 2>$outdir/abyss2_k84_trans.err
